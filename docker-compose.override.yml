version: '3.8'

services:

  webserver:
    build:
      context: .
      dockerfile: ./infra/nginx/Dockerfile
    ports:
      - "${APP_PORT}:80"
    volumes:
      - ./infra/nginx/conf.d:/etc/nginx/conf.d
      - ./frontend/public:/var/www/public

  backend:
    build:
      context: ./backend
      dockerfile: ../infra/nestjs/Dockerfile
      target: dependencies
    environment:
      SERVICE_NAME: backend
      SERVICE_TAGS: dev
      NODE_ENV: development
    volumes:
      - /var/www/backend/node_modules
    depends_on:
      - mariadb
    command: yarn start:dev

  frontend:
    build:
      context: ./frontend
      dockerfile: ../infra/vite/Dockerfile
      target: dependencies
    ports:
      - "3000:3000"
    environment:
      SERVICE_NAME: frontend
      SERVICE_TAGS: dev
      NODE_ENV: development
    volumes:
      - /var/www/node_modules
    command: yarn dev
    
  mariadb:
    image: mariadb
    environment:
      - MARIADB_DATABASE=${DB_DATABASE}
      - MARIADB_ROOT_PASSWORD=${DB_PASSWORD_ROOT}
      - MARIADB_USER=${DB_USERNAME}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    volumes:
      # - ./infra/mysql/my.cnf:/etc/mysql/my.cnf
      - ./infra/database/.docker/dbdata:/var/lib/mysql
      # - ./infra/database/dump.sql:/docker-entrypoint-initdb.d/dump.sql
    networks:
      - db-network

  keycloak:
    ports:
      - 8080:8080
    environment:
      - KEYCLOAK_HTTP_PORT=80
      - DEBUG=true
      # - KEYCLOAK_USER=admin
      # - KEYCLOAK_PASSWORD=admin
      - KEYCLOAK_HOSTNAME=localhost
    build:
      context: infra/keycloak
      dockerfile: ./Dockerfile
    volumes:
      # - ./infra/keycloak/themes:/opt/jboss/keycloak/themes
      - ./infra/keycloak/configuration:/opt/jboss/keycloak/standalone/configuration


  # database-keycloak:
  #   volumes:
  #     - ./infra/keycloak/mysql/keycloak-dump.sql:/docker-entrypoint-initdb.d/dump.sql

  phpmyadmin:
    image: phpmyadmin
    ports:
      - 8001:80
    environment:
      - PMA_HOST=mariadb
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD_ROOT}
      - PMA_USER=${DB_USERNAME}
      - PMA_PASSWORD=${DB_PASSWORD}
    networks:
      - db-network
    depends_on:
      - mariadb

  rabbitmq:
    ports:
      - 15672:15672
